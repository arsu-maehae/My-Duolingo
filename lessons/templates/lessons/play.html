{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lv.{{ level.level_number }} - ‡∏ù‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+Thai:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans Thai', sans-serif; background-color: #f4f7f6; }
        #quiz-card { border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.05) !important; border: 2px solid #e5e5e5; }
        #jp-text { font-family: 'Fredoka', sans-serif; letter-spacing: 1px; }
        #btn-speak { background-color: #f0f4f8; border: 2px solid #dce4eb; color: #1cb0f6 !important; transition: all 0.2s; }
        #btn-speak:hover { background-color: #e0f0ff; transform: scale(1.05); }
        #answer-input { border: 2px solid #e5e5e5; border-radius: 16px; background-color: #f9f9f9; transition: all 0.3s; box-shadow: none; }
        #answer-input:focus { border-color: #1cb0f6; background-color: #ffffff; }
        #selected-words-zone { border: 2px dashed #cecece !important; border-radius: 16px !important; background-color: #f9f9f9 !important; }
        .word-btn { border: 2px solid #e5e5e5; background-color: white; color: #4b4b4b; font-weight: 600; border-bottom: 4px solid #e5e5e5; transition: 0.1s; }
        .word-btn:hover { background-color: #f0f0f0; transform: translateY(2px); border-bottom-width: 2px; margin-bottom: 2px; }
        .btn-game { border: none; font-weight: bold; font-size: 1.2rem; padding: 12px; transition: 0.1s; }
        .btn-check-ans { background-color: #1cb0f6; color: white; border-bottom: 5px solid #1899d6; }
        .btn-check-ans:active { border-bottom-width: 0; transform: translateY(5px); }
        .btn-next-q { background-color: #58cc02; color: white; border-bottom: 5px solid #58a700; }
        .btn-next-q:active { border-bottom-width: 0; transform: translateY(5px); }
        .btn-override-ans { background-color: #ffc800; color: #c95100; border-bottom: 5px solid #e5a700; }
        .btn-override-ans:active { border-bottom-width: 0; transform: translateY(5px); }
        .alert { border-radius: 16px; border: none; font-weight: 500; }
        .alert-success { background-color: #d7ffb8; color: #2b7a0b; }
        .alert-danger { background-color: #ffdfe0; color: #ea2b2b; }
        .progress-indicator { background-color: #e5e5e5; height: 12px; border-radius: 10px; width: 150px; overflow: hidden; }
        .progress-bar-fill { background-color: #58cc02; height: 100%; transition: width 0.4s ease; }
        
        @keyframes slideInFromRight {
            0% { opacity: 0; transform: translateX(50px); }
            100% { opacity: 1; transform: translateX(0); }
        }
        .slide-animation { animation: slideInFromRight 0.4s cubic-bezier(0.25, 0.8, 0.25, 1) forwards; }
    </style>
</head>
<body>
    <div class="container py-3" style="max-width: 650px;">
        
        <div class="d-flex justify-content-between align-items-center mb-4 px-2">
            <a href="#" id="btn-close-page" class="text-secondary fs-4 text-decoration-none"><i class="fas fa-times"></i></a>
            
            <div class="progress-indicator flex-grow-1 mx-4">
                <div id="progress-bar" class="progress-bar-fill" style="width: 20%;"></div> 
            </div>
            <h5 class="mb-0 fw-bold text-secondary" id="progress-text">1/5</h5>
        </div>

        <div id="quiz-card" class="card bg-white mt-3">
            <div class="card-body p-sm-5 p-4 text-center">
                <button id="btn-speak" class="btn rounded-circle mb-4 shadow-sm" style="width: 75px; height: 75px;">
                    <i class="fas fa-volume-up fa-2x"></i>
                </button>
                <h1 class="display-3 fw-bold text-dark mb-1" id="jp-text">...</h1>
                
                <div id="hint-box" class="mb-4 mt-2" style="cursor: pointer; height: 40px; position: relative;">
                    <span id="hint-text" class="text-muted fs-6" style="transition: opacity 0.3s; position: absolute; width: 100%; left: 0;">
                        <span class="bg-light px-3 py-1 rounded-pill border"><i class="fas fa-lightbulb text-warning"></i> ‡∏î‡∏π‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô</span>
                    </span>
                    <span id="jp-reading" class="text-primary fs-4 fw-bold" style="opacity: 0; transition: opacity 0.3s; position: absolute; width: 100%; left: 0;">...</span>
                </div>

                <div id="word-input-container" class="mb-4 text-start px-md-4">
                    <input type="text" id="answer-input" class="form-control form-control-lg text-center fs-4 py-3" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢" autocomplete="off">
                </div>

                <div id="sentence-ui-container" class="mb-4 d-none">
                    <div id="selected-words-zone" class="p-3 mb-4 rounded d-flex flex-wrap justify-content-center gap-2 align-items-center"></div>
                    <hr class="text-muted opacity-25">
                    <div id="word-bank-zone" class="d-flex flex-wrap justify-content-center gap-2 mt-3"></div>
                </div>

                <div id="feedback-area" class="alert d-none mb-4 p-4 text-start" role="alert"></div>
            </div>
        </div>
        
        <div id="action-buttons-container" class="mt-4 px-2">
            <button id="btn-check" class="btn btn-game btn-check-ans w-100 rounded-pill">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</button>
            
            <button id="btn-next" class="btn btn-game btn-next-q w-100 rounded-pill d-none">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</button>
        </div>

        <div id="result-screen" class="card shadow border-0 rounded-4 d-none text-center mt-5">
            <div class="card-body p-5">
                <div class="mb-4 text-warning"><i class="fas fa-star fa-5x"></i></div>
                <h2 class="mb-3 fw-bold text-dark">‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å! ‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</h2>
                <h1 class="display-2 fw-bold text-success mb-4"><span id="final-score">0</span> / 5</h1>
                <a href="#" id="btn-finish-game" class="btn btn-game btn-check-ans rounded-pill px-5">‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠</a>
            </div>
        </div>
    </div>

    {{ questions|json_script:"questions-data" }}
    <script src="https://unpkg.com/wanakana"></script>
    <script src="{% static 'lessons/js/play.js' %}?v=5"></script>
    
    <script>
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length) {
                    mutation.addedNodes.forEach(node => {
                        if(node.tagName === 'BUTTON' && node.parentElement && (node.parentElement.id === 'word-bank-zone' || node.parentElement.id === 'selected-words-zone')) {
                            node.className = 'btn word-btn btn-lg rounded-pill px-4'; 
                        }
                    });
                }
            });
        });
        const bankZone = document.getElementById('word-bank-zone');
        if(bankZone) observer.observe(bankZone, { childList: true });

        // üåü ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏¥‡∏î‡∏à‡∏≠ Iframe ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏≤‡∏´‡∏ô‡πâ‡∏≤ Home
        document.getElementById('btn-close-page').addEventListener('click', function(e) {
            e.preventDefault(); 
            window.parent.postMessage('closeGameModal', '*'); 
        });
        document.getElementById('btn-finish-game').addEventListener('click', function(e) {
            e.preventDefault(); 
            window.parent.postMessage('closeGameModal', '*'); 
        });
    </script>
</body>
</html>